!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("ot-es",[],t):"object"==typeof exports?exports["ot-es"]=t():e["ot-es"]=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function i(e){return"object"==typeof e&&null!==e}function o(e){return void 0===e}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if(!function(e){return"number"==typeof e}(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,s,a,u,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(o(n=this._events[e]))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),n.apply(this,a)}else if(i(n))for(a=Array.prototype.slice.call(arguments,1),s=(c=n.slice()).length,u=0;u<s;u++)c[u].apply(this,a);return!0},n.prototype.addListener=function(e,t){var s;if(!r(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned&&(s=o(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){if(!r(t))throw TypeError("listener must be a function");var n=!1;function i(){this.removeListener(e,i),n||(n=!0,t.apply(this,arguments))}return i.listener=t,this.on(e,i),this},n.prototype.removeListener=function(e,t){var n,o,s,a;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(s=(n=this._events[e]).length,o=-1,n===t||r(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(n)){for(a=s;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=a;break}if(o<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(o,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r(n=this._events[e]))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(r(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,n){(function(e,r){var i=/%[sdj%]/g;t.format=function(e){if(!g(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(a(arguments[n]));return t.join(" ")}n=1;for(var r=arguments,o=r.length,s=String(e).replace(i,function(e){if("%%"===e)return"%";if(n>=o)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(e){return"[Circular]"}default:return e}}),u=r[n];n<o;u=r[++n])d(u)||!w(u)?s+=" "+u:s+=" "+a(u);return s},t.deprecate=function(n,i){if(m(e.process))return function(){return t.deprecate(n,i).apply(this,arguments)};if(!0===r.noDeprecation)return n;var o=!1;return function(){if(!o){if(r.throwDeprecation)throw new Error(i);r.traceDeprecation?console.trace(i):console.error(i),o=!0}return n.apply(this,arguments)}};var o,s={};function a(e,n){var r={seen:[],stylize:c};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),v(n)?r.showHidden=n:n&&t._extend(r,n),m(r.showHidden)&&(r.showHidden=!1),m(r.depth)&&(r.depth=2),m(r.colors)&&(r.colors=!1),m(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=u),l(r,e,r.depth)}function u(e,t){var n=a.styles[t];return n?"["+a.colors[n][0]+"m"+e+"["+a.colors[n][1]+"m":e}function c(e,t){return e}function l(e,n,r){if(e.customInspect&&n&&O(n.inspect)&&n.inspect!==t.inspect&&(!n.constructor||n.constructor.prototype!==n)){var i=n.inspect(r,e);return g(i)||(i=l(e,i,r)),i}var o=function(e,t){if(m(t))return e.stylize("undefined","undefined");if(g(t)){var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string")}if(y(t))return e.stylize(""+t,"number");if(v(t))return e.stylize(""+t,"boolean");if(d(t))return e.stylize("null","null")}(e,n);if(o)return o;var s=Object.keys(n),a=function(e){var t={};return e.forEach(function(e,n){t[e]=!0}),t}(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(n)),S(n)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return h(n);if(0===s.length){if(O(n)){var u=n.name?": "+n.name:"";return e.stylize("[Function"+u+"]","special")}if(b(n))return e.stylize(RegExp.prototype.toString.call(n),"regexp");if(k(n))return e.stylize(Date.prototype.toString.call(n),"date");if(S(n))return h(n)}var c,w="",_=!1,C=["{","}"];(p(n)&&(_=!0,C=["[","]"]),O(n))&&(w=" [Function"+(n.name?": "+n.name:"")+"]");return b(n)&&(w=" "+RegExp.prototype.toString.call(n)),k(n)&&(w=" "+Date.prototype.toUTCString.call(n)),S(n)&&(w=" "+h(n)),0!==s.length||_&&0!=n.length?r<0?b(n)?e.stylize(RegExp.prototype.toString.call(n),"regexp"):e.stylize("[Object]","special"):(e.seen.push(n),c=_?function(e,t,n,r,i){for(var o=[],s=0,a=t.length;s<a;++s)E(t,String(s))?o.push(f(e,t,n,r,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(f(e,t,n,r,i,!0))}),o}(e,n,r,a,s):s.map(function(t){return f(e,n,r,a,t,_)}),e.seen.pop(),function(e,t,n){if(e.reduce(function(e,t){return 0,t.indexOf("\n")>=0&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(c,w,C)):C[0]+w+C[1]}function h(e){return"["+Error.prototype.toString.call(e)+"]"}function f(e,t,n,r,i,o){var s,a,u;if((u=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=u.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):u.set&&(a=e.stylize("[Setter]","special")),E(r,i)||(s="["+i+"]"),a||(e.seen.indexOf(u.value)<0?(a=d(n)?l(e,u.value,null):l(e,u.value,n-1)).indexOf("\n")>-1&&(a=o?a.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+a.split("\n").map(function(e){return"   "+e}).join("\n")):a=e.stylize("[Circular]","special")),m(s)){if(o&&i.match(/^\d+$/))return a;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+a}function p(e){return Array.isArray(e)}function v(e){return"boolean"==typeof e}function d(e){return null===e}function y(e){return"number"==typeof e}function g(e){return"string"==typeof e}function m(e){return void 0===e}function b(e){return w(e)&&"[object RegExp]"===_(e)}function w(e){return"object"==typeof e&&null!==e}function k(e){return w(e)&&"[object Date]"===_(e)}function S(e){return w(e)&&("[object Error]"===_(e)||e instanceof Error)}function O(e){return"function"==typeof e}function _(e){return Object.prototype.toString.call(e)}function C(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(m(o)&&(o=r.env.NODE_DEBUG||""),e=e.toUpperCase(),!s[e])if(new RegExp("\\b"+e+"\\b","i").test(o)){var n=r.pid;s[e]=function(){var r=t.format.apply(t,arguments);console.error("%s %d: %s",e,n,r)}}else s[e]=function(){};return s[e]},t.inspect=a,a.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},a.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=p,t.isBoolean=v,t.isNull=d,t.isNullOrUndefined=function(e){return null==e},t.isNumber=y,t.isString=g,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=m,t.isRegExp=b,t.isObject=w,t.isDate=k,t.isError=S,t.isFunction=O,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=n(4);var x=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function E(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){console.log("%s - %s",function(){var e=new Date,t=[C(e.getHours()),C(e.getMinutes()),C(e.getSeconds())].join(":");return[e.getDate(),x[e.getMonth()],t].join(" ")}(),t.format.apply(t,arguments))},t.inherits=n(5),t._extend=function(e,t){if(!t||!w(t))return e;for(var n=Object.keys(t),r=n.length;r--;)e[n[r]]=t[n[r]];return e}}).call(this,n(2),n(3))},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){var n,r,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var u,c=[],l=!1,h=-1;function f(){l&&u&&(l=!1,u.length?c=u.concat(c):h=-1,c.length&&p())}function p(){if(!l){var e=a(f);l=!0;for(var t=c.length;t;){for(u=c,c=[];++h<t;)u&&u[h].run();h=-1,t=c.length}u=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function d(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new v(e,t)),1!==c.length||l||a(p)},v.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=d,i.addListener=d,i.once=d,i.off=d,i.removeListener=d,i.removeAllListeners=d,i.emit=d,i.prependListener=d,i.prependOnceListener=d,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t){e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(t);var o=function(e){return"number"==typeof e&&e>0},s=function(e){return"string"==typeof e},a=function(e){return"number"==typeof e&&e<0},u=function(){function e(){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!this||this.constructor!==e)return new e;this.ops=[],this.baseLength=0,this.targetLength=0}return function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,[{key:"equals",value:function(e){if(this.baseLength!==e.baseLength)return!1;if(this.targetLength!==e.targetLength)return!1;if(this.ops.length!==e.ops.length)return!1;for(var t=0;t<this.ops.length;t++)if(this.ops[t]!==e.ops[t])return!1;return!0}},{key:"retain",value:function(e){if("number"!=typeof e)throw new Error("retain expects an integer");return 0===e?this:(this.baseLength+=e,this.targetLength+=e,o(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e),this)}},{key:"insert",value:function(e){if("string"!=typeof e)throw new Error("insert expects a string");if(""===e)return this;this.targetLength+=e.length;var t=this.ops;return s(t[t.length-1])?t[t.length-1]+=e:a(t[t.length-1])?s(t[t.length-2])?t[t.length-2]+=e:(t[t.length]=t[t.length-1],t[t.length-2]=e):t.push(e),this}},{key:"delete",value:function(e){if("string"==typeof e&&(e=e.length),"number"!=typeof e)throw new Error("delete expects an integer or a string");return 0===e?this:(e>0&&(e=-e),this.baseLength-=e,a(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e),this)}},{key:"isNoop",value:function(){return 0===this.ops.length||1===this.ops.length&&o(this.ops[0])}},{key:"toString",value:function(){return(Array.prototype.map||function(e){for(var t=[],n=0,r=this.length;n<r;n++)t[n]=e(this[n]);return t}).call(this.ops,function(e){return o(e)?"retain "+e:s(e)?"insert '"+e+"'":"delete "+-e}).join(", ")}},{key:"toJSON",value:function(){return this.ops}},{key:"apply",value:function(e){if(e.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var t=[],n=0,r=0,i=this.ops,a=0,u=i.length;a<u;a++){var c=i[a];if(o(c)){if(r+c>e.length)throw new Error("Operation can't retain more characters than are left in the string.");t[n++]=e.slice(r,r+c),r+=c}else s(c)?t[n++]=c:r-=c}if(r!==e.length)throw new Error("The operation didn't operate on the whole string.");return t.join("")}},{key:"invert",value:function(t){for(var n=0,r=new e,i=this.ops,a=0,u=i.length;a<u;a++){var c=i[a];o(c)?(r.retain(c),n+=c):s(c)?r.delete(c.length):(r.insert(t.slice(n,n-c)),n-=c)}return r}},{key:"compose",value:function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var n=new e,r=this.ops,i=t.ops,u=0,c=0,l=r[u++],h=i[c++];void 0!==l||void 0!==h;)if(a(l))n.delete(l),l=r[u++];else if(s(h))n.insert(h),h=i[c++];else{if(void 0===l)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===h)throw new Error("Cannot compose operations: first operation is too long.");if(o(l)&&o(h))l>h?(n.retain(h),l-=h,h=i[c++]):l===h?(n.retain(l),l=r[u++],h=i[c++]):(n.retain(l),h-=l,l=r[u++]);else if(s(l)&&a(h))l.length>-h?(l=l.slice(-h),h=i[c++]):l.length===-h?(l=r[u++],h=i[c++]):(h+=l.length,l=r[u++]);else if(s(l)&&o(h))l.length>h?(n.insert(l.slice(0,h)),l=l.slice(h),h=i[c++]):l.length===h?(n.insert(l),l=r[u++],h=i[c++]):(n.insert(l),h-=l.length,l=r[u++]);else{if(!o(l)||!a(h))throw new Error("This shouldn't happen: op1: "+JSON.stringify(l)+", op2: "+JSON.stringify(h));l>-h?(n.delete(h),l+=h,h=i[c++]):l===-h?(n.delete(h),l=r[u++],h=i[c++]):(n.delete(l),h+=l,l=r[u++])}}return n}},{key:"_getSimpleOp",value:function(t,n){var r=t.ops,i=e.isRetain;switch(r.length){case 1:return r[0];case 2:return i(r[0])?r[1]:i(r[1])?r[0]:null;case 3:if(i(r[0])&&i(r[2]))return r[1]}return null}},{key:"_getStartIndex",value:function(e){return o(e.ops[0])?e.ops[0]:0}},{key:"shouldBeComposedWith",value:function(e){if(this.isNoop()||e.isNoop())return!0;var t=this._getStartIndex(this),n=this._getStartIndex(e),r=this._getSimpleOp(this),i=this._getSimpleOp(e);return!(!r||!i)&&(s(r)&&s(i)?t+r.length===n:!(!a(r)||!a(i))&&(n-i===t||t===n))}},{key:"shouldBeComposedWithInverted",value:function(e){if(this.isNoop()||e.isNoop())return!0;var t=this._getStartIndex(this),n=this._getStartIndex(e),r=this._getSimpleOp(this),i=this._getSimpleOp(e);return!(!r||!i)&&(s(r)&&s(i)?t+r.length===n||t===n:!(!a(r)||!a(i))&&n-i===t)}}]),e}();function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}i(u,"isRetain",o),i(u,"isInsert",s),i(u,"isDelete",a),i(u,"fromJSON",function(e){for(var t=new u,n=0,r=e.length;n<r;n++){var i=e[n];if(o(i))t.retain(i);else if(s(i))t.insert(i);else{if(!a(i))throw new Error("unknown operation: "+JSON.stringify(i));t.delete(i)}}return t}),i(u,"transform",function(e,t){if(e.baseLength!==t.baseLength)throw new Error("Both operations have to have the same base length");for(var n=new u,r=new u,i=e.ops,c=t.ops,l=0,h=0,f=i[l++],p=c[h++];void 0!==f||void 0!==p;)if(s(f))n.insert(f),r.retain(f.length),f=i[l++];else if(s(p))n.retain(p.length),r.insert(p),p=c[h++];else{if(void 0===f)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===p)throw new Error("Cannot compose operations: first operation is too long.");var v;if(o(f)&&o(p))f>p?(v=p,f-=p,p=c[h++]):f===p?(v=p,f=i[l++],p=c[h++]):(v=f,p-=f,f=i[l++]),n.retain(v),r.retain(v);else if(a(f)&&a(p))-f>-p?(f-=p,p=c[h++]):f===p?(f=i[l++],p=c[h++]):(p-=f,f=i[l++]);else if(a(f)&&o(p))-f>p?(v=p,f+=p,p=c[h++]):-f===p?(v=p,f=i[l++],p=c[h++]):(v=-f,p+=f,f=i[l++]),n.delete(v);else{if(!o(f)||!a(p))throw new Error("The two operations aren't compatible");f>-p?(v=-p,f+=p,p=c[h++]):f===-p?(v=f,f=i[l++],p=c[h++]):(v=f,p+=f,f=i[l++]),r.delete(v)}}return[n,r]});var p=function(){function e(t,n){l(this,e),this.count=t,this.position=n}return f(e,[{key:"toString",value:function(){return"Delete("+this.count+", "+this.position+")"}},{key:"equals",value:function(t){return t instanceof e&&this.count===t.count&&this.position===t.position}},{key:"apply",value:function(e){return e.slice(0,this.position)+e.slice(this.position+this.count)}}]),e}(),v=function(){function e(t,n){l(this,e),this.str=t,this.position=n}return f(e,[{key:"toString",value:function(){return"Insert("+JSON.stringify(this.str)+", "+this.position+")"}},{key:"equals",value:function(t){return t instanceof e&&this.str===t.str&&this.position===t.position}},{key:"apply",value:function(e){return e.slice(0,this.position)+this.str+e.slice(this.position)}}]),e}(),d=function(){function e(){l(this,e)}return f(e,[{key:"toString",value:function(){return"Noop()"}},{key:"equals",value:function(t){return t instanceof e}},{key:"apply",value:function(e){return e}}]),e}(),y=new d,g=function e(){l(this,e)};function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}c(g,"Insert",v),c(g,"Delete",p),c(g,"Noop",d),c(g,"transform",function(e,t){if(e instanceof d||t instanceof d)return[e,t];if(e instanceof v&&t instanceof v)return e.position<t.position||e.position===t.position&&e.str<t.str?[e,new v(t.str,t.position+e.str.length)]:e.position>t.position||e.position===t.position&&e.str>t.str?[new v(e.str,e.position+t.str.length),t]:[y,y];if(e instanceof v&&t instanceof p)return e.position<=t.position?[e,new p(t.count,t.position+e.str.length)]:e.position>=t.position+t.count?[new v(e.str,e.position-t.count),t]:[y,new p(t.count+e.str.length,t.position)];if(e instanceof p&&t instanceof v)return e.position>=t.position?[new p(e.count,e.position+t.str.length),t]:e.position+e.count<=t.position?[e,new v(t.str,t.position-e.count)]:[new p(e.count+t.str.length,e.position),y];if(e instanceof p&&t instanceof p){if(e.position===t.position)return e.count===t.count?[y,y]:e.count<t.count?[y,new p(t.count-e.count,t.position)]:[new p(e.count-t.count,e.position),y];if(e.position<t.position)return e.position+e.count<=t.position?[e,new p(t.count,t.position-e.count)]:e.position+e.count>=t.position+t.count?[new p(e.count-t.count,e.position),y]:[new p(t.position-e.position,e.position),new p(t.position+t.count-(e.position+e.count),e.position)];if(e.position>t.position)return e.position>=t.position+t.count?[new p(e.count,e.position-t.count),t]:e.position+e.count<=t.position+t.count?[y,new p(t.count-e.count,t.position)]:[new p(e.position+e.count-(t.position+t.count),t.position),new p(e.position-t.position,t.position)]}}),c(g,"fromTextOperation",function(e){for(var t=[],n=0,r=0;r<e.ops.length;r++){var i=e.ops[r];u.isRetain(i)?n+=i:u.isInsert(i)?(t.push(new v(i,n)),n+=i.length):t.push(new p(Math.abs(i),n))}return t});var w=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.wrapped=t,this.meta=n}return function(e,t,n){t&&b(e.prototype,t),n&&b(e,n)}(e,[{key:"apply",value:function(){return this.wrapped.apply.apply(this.wrapped,arguments)}},{key:"invert",value:function(){var t=this.meta;return new e(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"===m(t)&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)}},{key:"_copy",value:function(e,t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}},{key:"_composeMeta",value:function(e,t){if(e&&"object"===m(e)){if("function"==typeof e.compose)return e.compose(t);var n={};return this._copy(e,n),this._copy(t,n),n}return t}},{key:"compose",value:function(t){return new e(this.wrapped.compose(t.wrapped),this._composeMeta(this.meta,t.meta))}}]),e}();function k(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function S(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function O(e,t,n){return t&&S(e.prototype,t),n&&S(e,n),e}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(w,"transform",function(e,t){var n=function(e,t){return e&&"object"===m(e)&&"function"==typeof e.transform?e.transform(t):e},r=(0,e.wrapped.constructor.transform)(e.wrapped,t.wrapped);return[new w(r[0],n(e.meta,t.wrapped)),new w(r[1],n(t.meta,e.wrapped))]});var C=function(){function e(t,n){k(this,e),this.anchor=t,this.head=n}return O(e,[{key:"equals",value:function(e){return this.anchor===e.anchor&&this.head===e.head}},{key:"isEmpty",value:function(){return this.anchor===this.head}},{key:"transform",value:function(t){function n(e){for(var n=e,r=t.ops,i=0,o=t.ops.length;i<o&&(u.isRetain(r[i])?e-=r[i]:u.isInsert(r[i])?n+=r[i].length:(n-=Math.min(e,-r[i]),e+=r[i]),!(e<0));i++);return n}var r=n(this.anchor);return this.anchor===this.head?new e(r,r):new e(r,n(this.head))}}]),e}();_(C,"fromJSON",function(e){return new C(e.anchor,e.head)});var x=function(){function e(t){k(this,e),this.ranges=t||[]}return O(e,[{key:"equals",value:function(e){if(this.position!==e.position)return!1;if(this.ranges.length!==e.ranges.length)return!1;for(var t=0;t<this.ranges.length;t++)if(!this.ranges[t].equals(e.ranges[t]))return!1;return!0}},{key:"somethingSelected",value:function(){for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].isEmpty())return!0;return!1}},{key:"compose",value:function(e){return e}},{key:"transform",value:function(t){for(var n=0,r=[];n<this.ranges.length;n++)r[n]=this.ranges[n].transform(t);return new e(r)}}]),e}();function E(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}_(x,"Range",C),_(x,"createCursor",function(e){return new x([new C(e,e)])}),_(x,"fromJSON",function(e){for(var t=e.ranges||e,n=0,r=[];n<t.length;n++)r[n]=C.fromJSON(t[n]);return new x(r)});var j=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.ownUserName=n,this.majorRevision=r.major||0,this.minorRevision=r.minor||0,this.poll()}return function(e,t,n){t&&E(e.prototype,t),n&&E(e,n)}(e,[{key:"renderRevisionPath",value:function(){return"revision/"+this.majorRevision+"-"+this.minorRevision}},{key:"handleResponse",value:function(e){var t,n=e.operations;for(t=0;t<n.length;t++)n[t].user===this.ownUserName?this.trigger("ack"):this.trigger("operation",n[t].operation);n.length>0&&(this.majorRevision+=n.length,this.minorRevision=0);var r=e.events;if(r){for(t=0;t<r.length;t++){var i=r[t].user;if(i!==this.ownUserName)switch(r[t].event){case"joined":this.trigger("set_name",i,i);break;case"left":this.trigger("client_left",i);break;case"selection":this.trigger("selection",i,r[t].selection)}}this.minorRevision+=r.length}var o=e.users;o&&(delete o[this.ownUserName],this.trigger("clients",o)),e.revision&&(this.majorRevision=e.revision.major,this.minorRevision=e.revision.minor)}},{key:"poll",value:function(){var e=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"GET",dataType:"json",timeout:5e3,success:function(t){e.handleResponse(t),e.poll()},error:function(){setTimeout(function(){e.poll()},500)}})}},{key:"sendOperation",value:function(e,t,n){if(e!==this.majorRevision)throw new Error("Revision numbers out of sync");var r=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"POST",data:JSON.stringify({operation:t,selection:n}),contentType:"application/json",processData:!1,success:function(e){},error:function(){setTimeout(function(){r.sendOperation(e,t,n)},500)}})}},{key:"sendSelection",value:function(e){$.ajax({url:this.path+this.renderRevisionPath()+"/selection",type:"POST",data:JSON.stringify(e),contentType:"application/json",processData:!1,timeout:1e3})}},{key:"registerCallbacks",value:function(e){this.callbacks=e}},{key:"trigger",value:function(e){var t=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[e];n&&n.apply(this,t)}}]),e}();function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function A(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function N(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function T(e,t,n){return t&&N(e.prototype,t),n&&N(e,n),e}var P=function(){function e(t){A(this,e),this.outstanding=t}return T(e,[{key:"applyClient",value:function(e,t){return new F(this.outstanding,t)}},{key:"applyServer",value:function(t,n,r){if(n-t.revision>1)throw new Error("Invalid revision.");t.revision=n;var i=r.constructor.transform(this.outstanding,r);return t.applyOperation(i[1]),new e(i[0])}},{key:"serverAck",value:function(e,t){return t-e.revision>1?new J(this.outstanding,e,t).getOperations():(e.revision=t,R)}},{key:"transformSelection",value:function(e){return e.transform(this.outstanding)}},{key:"resend",value:function(e){e.sendOperation(e.revision,this.outstanding)}}]),e}(),I=function(){function e(){A(this,e)}return T(e,[{key:"applyClient",value:function(e,t){return e.sendOperation(e.revision,t),new P(t)}},{key:"applyServer",value:function(e,t,n){if(t-e.revision>1)throw new Error("Invalid revision.");return e.revision=t,e.applyOperation(n),this}},{key:"serverAck",value:function(e,t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(e){return e}}]),e}(),R=new I,M=function(){function e(t,n,r,i){A(this,e),this.acknowlaged=t,this.buffer=n,this.client=r,this.revision=i}return T(e,[{key:"applyClient",value:function(t,n){var r=this.buffer.compose(n);return new e(this.acknowlaged,r,t,this.revision)}},{key:"applyServer",value:function(e,t,n){throw new Error("Ignored server-side change.")}},{key:"applyOperations",value:function(e,t,n){for(var r=this.acknowlaged.constructor.transform,i=0;i<n.length;i++){var o=ot.TextOperation.fromJSON(n[i]),s=r(this.acknowlaged,o),a=r(this.buffer,s[1]);e.applyOperation(a[1]),this.acknowlaged=s[0],this.buffer=a[0]}return e.revision=this.revision,e.sendOperation(e.revision,this.buffer),new P(this.buffer)}},{key:"serverAck",value:function(e,t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(e){return e}},{key:"getOperations",value:function(){return this.client.getOperations(this.client.revision,this.revision-1),this}}]),e}(),J=function(){function e(t,n,r){A(this,e),this.acknowlaged=t,this.client=n,this.revision=r}return T(e,[{key:"applyClient",value:function(e,t){return new M(this.acknowlaged,t,e,this.revision)}},{key:"applyServer",value:function(e,t,n){throw new Error("Ignored server-side change.")}},{key:"applyOperations",value:function(e,t,n){for(var r=this.acknowlaged.constructor.transform,i=0;i<n.length;i++){var o=ot.TextOperation.fromJSON(n[i]),s=r(this.acknowlaged,o);e.applyOperation(s[1]),this.acknowlaged=s[0]}return e.revision=this.revision,R}},{key:"serverAck",value:function(e,t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(e){return e}},{key:"getOperations",value:function(){return this.client.getOperations(this.client.revision,this.revision-1),this}}]),e}(),F=function(){function e(t,n){A(this,e),this.outstanding=t,this.buffer=n}return T(e,[{key:"applyClient",value:function(t,n){var r=this.buffer.compose(n);return new e(this.outstanding,r)}},{key:"applyServer",value:function(t,n,r){if(n-t.revision>1)throw new Error("Invalid revision.");t.revision=n;var i=r.constructor.transform,o=i(this.outstanding,r),s=i(this.buffer,o[1]);return t.applyOperation(s[1]),new e(o[0],s[0])}},{key:"serverAck",value:function(e,t){return t-e.revision>1?new M(this.outstanding,this.buffer,e,t).getOperations():(e.revision=t,e.sendOperation(e.revision,this.buffer),new P(this.buffer))}},{key:"transformSelection",value:function(e){return e.transform(this.outstanding).transform(this.buffer)}},{key:"resend",value:function(e){e.sendOperation(e.revision,this.outstanding)}}]),e}(),B=function(){function e(t){A(this,e),this.revision=t,this.setState(R)}return T(e,[{key:"setState",value:function(e){this.state=e}},{key:"applyClient",value:function(e){this.setState(this.state.applyClient(this,e))}},{key:"applyServer",value:function(e,t){this.setState(this.state.applyServer(this,e,t))}},{key:"applyOperations",value:function(e,t){this.setState(this.state.applyOperations(this,e,t))}},{key:"serverAck",value:function(e){this.setState(this.state.serverAck(this,e))}},{key:"serverReconnect",value:function(){"function"==typeof this.state.resend&&this.state.resend(this)}},{key:"transformSelection",value:function(e){return this.state.transformSelection(e)}},{key:"sendOperation",value:function(e,t){throw new Error("sendOperation must be defined in child class")}},{key:"applyOperation",value:function(e){throw new Error("applyOperation must be defined in child class")}}]),e}();function z(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L(B,"Synchronized",I),L(B,"AwaitingConfirm",P),L(B,"AwaitingWithBuffer",F);var D=function(e,t){return function(e,t){return e.line<t.line?-1:e.line>t.line?1:e.ch<t.ch?-1:e.ch>t.ch?1:0}(e,t)<=0},W=function(e,t){var n=function(e){return e.indexFromPos({line:e.lastLine(),ch:0})+e.getLine(e.lastLine()).length}(t),r=(new u).retain(n),i=(new u).retain(n),o=function(e){return t.indexFromPos(e)};function s(e){if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n].length;return t+e.length-1}function a(e,t){return function(n){return D(n,t.from)?e(n):D(t.to,n)?e({line:n.line+t.text.length-1-(t.to.line-t.from.line),ch:t.to.line<n.line?n.ch:t.text.length<=1?n.ch-(t.to.ch-t.from.ch)+s(t.text):n.ch-t.to.ch+function(e){return e[e.length-1]}(t.text).length})+s(t.removed)-s(t.text):t.from.line===n.line?e(t.from)+n.ch-t.from.ch:e(t.from)+s(t.removed.slice(0,n.line-t.from.line))+1+n.ch}}for(var c=e.length-1;c>=0;c--){var l=e[c],h=(o=a(o,l))(l.from),f=n-h-s(l.text);r=(new u).retain(h).delete(s(l.removed)).insert(l.text.join("\n")).retain(f).compose(r),i=i.compose((new u).retain(h).delete(s(l.text)).insert(l.removed.join("\n")).retain(f)),n+=s(l.removed)-s(l.text)}return[r,i]},q=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cm=t,this.ignoreNextChange=!1,this.changeInProgress=!1,this.selectionChanged=!1,this.addedStyle={},this.styleElement=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(this.styleElement),this.styleSheet=this.styleElement.sheet,this._bind(this,"onChanges"),this._bind(this,"onChange"),this._bind(this,"onCursorActivity"),this._bind(this,"onFocus"),this._bind(this,"onBlur"),t.on("changes",this.onChanges),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}return function(e,t,n){t&&z(e.prototype,t),n&&z(e,n)}(e,[{key:"detach",value:function(){this.cm.off("changes",this.onChanges),this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)}},{key:"registerCallbacks",value:function(e){this.callbacks=e}},{key:"onChange",value:function(){this.changeInProgress=!0}},{key:"onChanges",value:function(t,n){if(!this.ignoreNextChange){var r=e.operationFromCodeMirrorChanges(n,this.cm);this.trigger("change",r[0],r[1])}this.selectionChanged&&this.trigger("selectionChange"),this.changeInProgress=!1,this.ignoreNextChange=!1}},{key:"onFocus",value:function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")}},{key:"onCursorActivity",value:function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")}},{key:"onBlur",value:function(){this.cm.somethingSelected()||this.trigger("blur")}},{key:"getValue",value:function(){return this.cm.getValue()}},{key:"getSelection",value:function(){for(var e=this.cm,t=e.listSelections(),n=[],r=0;r<t.length;r++)n[r]=new x.Range(e.indexFromPos(t[r].anchor),e.indexFromPos(t[r].head));return new x(n)}},{key:"setSelection",value:function(e){for(var t=[],n=0;e&&n<e.ranges.length;n++){var r=e.ranges[n];t[n]={anchor:this.cm.posFromIndex(r.anchor),head:this.cm.posFromIndex(r.head)}}this.cm.setSelections(t)}},{key:"addStyleRule",value:function(e){this.addedStyle[e]||(this.addedStyle[e]=!0,this.styleSheet.insertRule(e,(this.styleSheet.cssRules||this.styleSheet.rules).length))}},{key:"setOtherCursor",value:function(e,t,n){var r=this.cm.posFromIndex(e),i=this.cm.cursorCoords(r),o=document.createElement("span");return o.className="other-client",o.style.display="inline-block",o.style.padding="0",o.style.marginLeft=o.style.marginRight="-1px",o.style.borderLeftWidth="2px",o.style.borderLeftStyle="solid",o.style.borderLeftColor=t,o.style.height=.9*(i.bottom-i.top)+"px",o.style.zIndex=0,o.setAttribute("data-clientid",n),this.cm.setBookmark(r,{widget:o,insertLeft:!0})}},{key:"setOtherSelectionRange",value:function(e,t,n){var r=/^#([0-9a-fA-F]{6})$/.exec(t);if(!r)throw new Error("only six-digit hex colors are allowed.");var i="selection-"+r[1],o=this._hex2rgb(t),s="."+i+" { background: rgba("+o.red+","+o.green+","+o.blue+",0.2); }";this.addStyleRule(s);var a=this.cm.posFromIndex(e.anchor),u=this.cm.posFromIndex(e.head);return this.cm.markText(function(e,t){return D(e,t)?e:t}(a,u),function(e,t){return D(e,t)?t:e}(a,u),{className:i})}},{key:"setOtherSelection",value:function(e,t,n){for(var r=[],i=0;i<e.ranges.length;i++){var o=e.ranges[i];o.isEmpty()?r[i]=this.setOtherCursor(o.head,t,n):r[i]=this.setOtherSelectionRange(o,t,n)}return{clear:function(){for(var e=0;e<r.length;e++)r[e]&&r[e].clear()}}}},{key:"trigger",value:function(e){var t=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[e];n&&n.apply(this,t)}},{key:"applyOperation",value:function(t){t.isNoop()||(this.ignoreNextChange=!0),e.applyOperationToCodeMirror(t,this.cm)}},{key:"registerUndo",value:function(e){this.cm.undo=e}},{key:"registerRedo",value:function(e){this.cm.redo=e}},{key:"_assert",value:function(e,t){if(!e)throw new Error(t||"assertion error")}},{key:"_bind",value:function(e,t){var n=e[t];e[t]=function(){n.apply(e,arguments)}}},{key:"_hex2rgb",value:function(e){if("#"===e[0]&&(e=e.substr(1)),3===e.length){var t=e;e="",t=/^([a-f0-9])([a-f0-9])([a-f0-9])$/i.exec(t).slice(1);for(var n=0;n<3;n++)e+=t[n]+t[n]}var r=/^([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(e).slice(1);return{red:parseInt(r[0],16),green:parseInt(r[1],16),blue:parseInt(r[2],16)}}}]),e}();function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}U(q,"operationFromCodeMirrorChanges",W),U(q,"operationFromCodeMirrorChange",W),U(q,"applyOperationToCodeMirror",function(e,t){t.operation(function(){for(var n=e.ops,r=0,i=0,o=n.length;i<o;i++){var s=n[i];if(u.isRetain(s))r+=s;else if(u.isInsert(s)){var a=t.getCursor(),c=t.posFromIndex(r);t.replaceRange(s,c,null,"ignoreHistory"),a.line===c.line&&a.ch===c.ch&&t.setCursor(a),r+=s.length}else if(u.isDelete(s)){var l=t.posFromIndex(r),h=t.posFromIndex(r-s);t.replaceRange("",l,h,"ignoreHistory")}}})});var G=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.socket=t;var n=this;t.on("client_left",function(e){n.trigger("client_left",e)}).on("set_name",function(e,t){n.trigger("set_name",e,t)}).on("set_color",function(e,t){n.trigger("set_color",e,t)}).on("ack",function(e){n.trigger("ack",e)}).on("operation",function(e,t,r,i){n.trigger("operation",t,r),n.trigger("selection",e,i)}).on("operations",function(e,t){n.trigger("operations",e,t)}).on("selection",function(e,t){n.trigger("selection",e,t)}).on("reconnect",function(){n.trigger("reconnect")})}return function(e,t,n){t&&H(e.prototype,t),n&&H(e,n)}(e,[{key:"sendOperation",value:function(e,t,n){this.socket.emit("operation",e,t,n)}},{key:"sendSelection",value:function(e){this.socket.emit("selection",e)}},{key:"getOperations",value:function(e,t){this.socket.emit("get_operations",e,t)}},{key:"registerCallbacks",value:function(e){this.callbacks=e}},{key:"trigger",value:function(e){var t=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[e];n&&n.apply(this,t)}}]),e}();function V(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Z="normal",K=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.maxItems=t||50,this.state=Z,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}return function(e,t,n){t&&V(e.prototype,t),n&&V(e,n)}(e,[{key:"add",value:function(e,t){if("undoing"===this.state)this.redoStack.push(e),this.dontCompose=!0;else if("redoing"===this.state)this.undoStack.push(e),this.dontCompose=!0;else{var n=this.undoStack;!this.dontCompose&&t&&n.length>0?n.push(e.compose(n.pop())):(n.push(e),n.length>this.maxItems&&n.shift()),this.dontCompose=!1,this.redoStack=[]}}},{key:"_transformStack",value:function(e,t){for(var n=[],r=t.constructor,i=e.length-1;i>=0;i--){var o=r.transform(e[i],t);"function"==typeof o[0].isNoop&&o[0].isNoop()||n.push(o[0]),t=o[1]}return n.reverse()}},{key:"transform",value:function(e){this.undoStack=this._transformStack(this.undoStack,e),this.redoStack=this._transformStack(this.redoStack,e)}},{key:"performUndo",value:function(e){if(this.state="undoing",0===this.undoStack.length)throw new Error("undo not possible");e(this.undoStack.pop()),this.state=Z}},{key:"performRedo",value:function(e){if(this.state="redoing",0===this.redoStack.length)throw new Error("redo not possible");e(this.redoStack.pop()),this.state=Z}},{key:"canUndo",value:function(){return 0!==this.undoStack.length}},{key:"canRedo",value:function(){return 0!==this.redoStack.length}},{key:"isUndoing",value:function(){return"undoing"===this.state}},{key:"isRedoing",value:function(){return"redoing"===this.state}}]),e}();function Q(e){return(Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function X(e){return(X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Y(e,t){return(Y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ee(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function te(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function re(e,t,n){return t&&ne(e.prototype,t),n&&ne(e,n),e}var ie=function(){function e(t,n,r,i,o,s){te(this,e),this.id=t,this.listEl=n,this.editorAdapter=r,this.name=i,this.color=o,this.li=document.createElement("li"),i&&(this.li.textContent=i,this.listEl.appendChild(this.li)),o?this.setForceColor(o):this.setColor(i?this._hueFromName(i):Math.random()),s&&this.updateSelection(s)}return re(e,[{key:"setColor",value:function(e){this.hue=e,this.color=this._hsl2hex(e,.75,.5),this.lightColor=this._hsl2hex(e,.5,.9),this.li&&(this.li.style.color=this.color)}},{key:"setForceColor",value:function(e){this.hue=null,this.color=e,this.lightColor=e,this.li&&(this.li.style.color=this.color)}},{key:"setName",value:function(e){this.name!==e&&(this.name=e,this.li.textContent=e,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(this._hueFromName(e)))}},{key:"updateSelection",value:function(e){this.removeSelection(),this.selection=e,this.mark=this.editorAdapter.setOtherSelection(e,e.position===e.selectionEnd?this.color:this.lightColor,this.id)}},{key:"remove",value:function(){this.li&&this._removeElement(this.li),this.removeSelection()}},{key:"removeSelection",value:function(){this.mark&&(this.mark.clear(),this.mark=null)}},{key:"_rgb2hex",value:function(e,t,n){function r(e){var t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t}return"#"+r(e)+r(t)+r(n)}},{key:"_hsl2hex",value:function(e,t,n){if(0===t)return this._rgb2hex(n,n,n);var r=n<.5?n*(1+t):n+t-t*n,i=2*n-r,o=function(e){return e<0&&(e+=1),e>1&&(e-=1),6*e<1?i+6*(r-i)*e:2*e<1?r:3*e<2?i+6*(r-i)*(2/3-e):i};return this._rgb2hex(o(e+1/3),o(e),o(e-1/3))}},{key:"_hueFromName",value:function(e){for(var t=1,n=0;n<e.length;n++)t=17*(t+e.charCodeAt(n))%360;return t/360}},{key:"_removeElement",value:function(e){e.parentNode&&e.parentNode.removeChild(e)}}]),e}(),oe=function(){function e(t,n){te(this,e),this.clientId=t,this.selection=n}return re(e,[{key:"transform",value:function(t){return new e(this.clientId,this.selection&&this.selection.transform(t))}}]),e}();!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(oe,"fromJSON",function(e){return new oe(e.clientId,e.selection&&x.fromJSON(e.selection))});var se=function(){function e(t,n){te(this,e),this.selectionBefore=t,this.selectionAfter=n}return re(e,[{key:"invert",value:function(){return new e(this.selectionAfter,this.selectionBefore)}},{key:"compose",value:function(t){return new e(this.selectionBefore,t.selectionAfter)}},{key:"transform",value:function(t){return new e(this.selectionBefore?this.selectionBefore.transform(t):null,this.selectionAfter?this.selectionAfter.transform(t):null)}}]),e}(),ae=function(e){function t(e,n,r,i){var o;te(this,t),(o=function(e,t){return!t||"object"!==Q(t)&&"function"!=typeof t?ee(e):t}(this,X(t).call(this,e))).serverAdapter=r,o.editorAdapter=i,o.undoManager=new K,o.initializeClientList(),o.initializeClients(n);var s=ee(ee(o));return o.editorAdapter.registerCallbacks({change:function(e,t){s.onChange(e,t)},selectionChange:function(){s.onSelectionChange()},blur:function(){s.onBlur()}}),o.editorAdapter.registerUndo(function(){s.undo()}),o.editorAdapter.registerRedo(function(){s.redo()}),o.serverAdapter.registerCallbacks({client_left:function(e){s.onClientLeft(e)},set_name:function(e,t){s.getClientObject(e).setName(t)},set_color:function(e,t){s.getClientObject(e).setForceColor(t)},ack:function(e){s.serverAck(e)},operation:function(e,t){s.applyServer(e,u.fromJSON(t))},operations:function(e,t){s.applyOperations(e,t)},selection:function(e,t){t?s.getClientObject(e).updateSelection(s.transformSelection(x.fromJSON(t))):s.getClientObject(e).removeSelection()},clients:function(e){var t;for(t in s.clients)s.clients.hasOwnProperty(t)&&!e.hasOwnProperty(t)&&s.onClientLeft(t);for(t in e)if(e.hasOwnProperty(t)){var n=s.getClientObject(t);e[t].name&&n.setName(e[t].name);var r=e[t].selection;r?s.clients[t].updateSelection(s.transformSelection(x.fromJSON(r))):s.clients[t].removeSelection()}},reconnect:function(){s.serverReconnect()}}),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Y(e,t)}(t,B),re(t,[{key:"addClient",value:function(e,t){this.clients[e]=new ie(e,this.clientListEl,this.editorAdapter,t.name||e,t.color||null,t.selection?x.fromJSON(t.selection):null)}},{key:"initializeClients",value:function(e){for(var t in this.clients={},e)e.hasOwnProperty(t)&&this.addClient(t,e[t])}},{key:"getClientObject",value:function(e){var t=this.clients[e];return t||(this.clients[e]=new ie(e,this.clientListEl,this.editorAdapter))}},{key:"onClientLeft",value:function(e){var t=this.clients[e];t&&(t.remove(),delete this.clients[e])}},{key:"initializeClientList",value:function(){this.clientListEl=document.createElement("ul")}},{key:"applyUnredo",value:function(e){this.undoManager.add(e.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(e.wrapped),this.selection=e.meta.selectionAfter,this.editorAdapter.setSelection(this.selection),this.applyClient(e.wrapped)}},{key:"undo",value:function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(t){e.applyUnredo(t)})}},{key:"redo",value:function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(t){e.applyUnredo(t)})}},{key:"onChange",value:function(e,t){var n=this.selection;this.updateSelection();var r=new se(n,this.selection),i=(new w(e,r),this.undoManager.undoStack.length>0&&t.shouldBeComposedWithInverted(this._last(this.undoManager.undoStack).wrapped)),o=new se(this.selection,n);this.undoManager.add(new w(t,o),i),this.applyClient(e)}},{key:"updateSelection",value:function(){this.selection=this.editorAdapter.getSelection()}},{key:"onSelectionChange",value:function(){var e=this.selection;this.updateSelection(),e&&this.selection.equals(e)||this.sendSelection(this.selection)}},{key:"onBlur",value:function(){this.selection=null,this.sendSelection(null)}},{key:"sendSelection",value:function(e){this.state instanceof B.AwaitingWithBuffer||this.serverAdapter.sendSelection(e)}},{key:"sendOperation",value:function(e,t){this.serverAdapter.sendOperation(e,t.toJSON(),this.selection)}},{key:"getOperations",value:function(e,t){this.serverAdapter.getOperations(e,t)}},{key:"applyOperation",value:function(e){this.editorAdapter.applyOperation(e),this.updateSelection(),this.undoManager.transform(new w(e,null))}},{key:"_last",value:function(e){return e[e.length-1]}}]),t}(),ue=n(0),ce=n.n(ue);function le(e){return(le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function he(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fe(e,t){return!t||"object"!==le(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pe(e){return(pe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ve(e,t){return(ve=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var de=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=fe(this,pe(t).call(this))).document=e,r.operations=n||[],r.setDocumentMaxLength(null),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ve(e,t)}(t,ce.a),function(e,t,n){t&&he(e.prototype,t),n&&he(e,n)}(t,[{key:"setDocumentMaxLength",value:function(e){this.documentMaxLength=e}},{key:"receiveOperation",value:function(e,t){if(e<0||this.operations.length<e)throw new Error("operation revision not in history");for(var n=this.operations.slice(e),r=t.constructor.transform,i=0;i<n.length;i++)t=r(t,n[i])[0];var o=t.apply(this.document);if(!("number"==typeof this.documentMaxLength&&o.length>this.documentMaxLength&&o.length>this.document.length))return this.document=o,this.operations.push(t),t}}]),t}();n(1);function ye(e){return(ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function me(e,t){return!t||"object"!==ye(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function be(e){return(be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function we(e,t){return(we=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ke=function(e){function t(e,n,r,i,o){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(s=me(this,be(t).call(this,e,n))).users={},s.docId=r,s.mayWrite=i||function(e,t){t(!0)},s.operationCallback=o,s.isBusy=!1,s.logger={info:function(){},error:function(){},debug:function(){}},s.debug=!1,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&we(e,t)}(t,de),function(e,t,n){t&&ge(e.prototype,t),n&&ge(e,n)}(t,[{key:"setLogger",value:function(e){this.logger=e}},{key:"debugLog",value:function(e){this.debug&&this.logger.debug(e)}},{key:"addClient",value:function(e){var t=this;e.join(this.docId).emit("doc",{str:this.document,revision:this.operations.length,clients:this.users}).on("operation",function(n,r,i){t.isBusy=!0,e.origin="operation",t.mayWrite(e,function(o){if(o)try{var s=t.onOperation(e,n,r,i);s&&(t.debugLog("new operation: "+JSON.stringify(s)),"function"==typeof t.operationCallback?t.operationCallback(e,s,function(){t.isBusy=!1}):t.isBusy=!1)}catch(n){t.logger.error(n),setTimeout(function(){e.emit("doc",{str:t.document,revision:t.operations.length,clients:t.users,force:!0})},100),t.isBusy=!1}else t.debugLog("User doesn't have the right to edit.")})}).on("get_operations",function(n,r){t.onGetOperations(e,n,r)}).on("selection",function(n){e.origin="selection",t.mayWrite(e,function(r){r?t.updateSelection(e,n&&x.fromJSON(n)):t.debugLog("User doesn't have the right to edit.")})}).on("disconnect",function(){t.debugLog("Disconnect"),e.leave(t.docId),t.onDisconnect(e)})}},{key:"onOperation",value:function(e,t,n,r){var i;try{i=new w(u.fromJSON(n),r&&x.fromJSON(r))}catch(e){throw this.logger.error("Invalid operation received: "),new Error(e)}try{var o=e.id,s=this.receiveOperation(t,i);if(!s)return;return this.getClient(o).selection=s.meta,t=this.operations.length,e.emit("ack",t),e.broadcast.to(this.docId).emit("operation",o,t,s.wrapped.toJSON(),s.meta),s.wrapped.toJSON()}catch(e){throw new Error(e)}}},{key:"onGetOperations",value:function(e,t,n){var r=this.operations.slice(t,n).map(function(e){return e.wrapped.toJSON()});e.emit("operations",n,r)}},{key:"updateSelection",value:function(e,t){var n=e.id;t?this.getClient(n).selection=t:delete this.getClient(n).selection,e.broadcast.to(this.docId).emit("selection",n,t)}},{key:"setName",value:function(e,t){var n=e.id;this.getClient(n).name=t,e.broadcast.to(this.docId).emit("set_name",n,t)}},{key:"setColor",value:function(e,t){var n=e.id;this.getClient(n).color=t,e.broadcast.to(this.docId).emit("set_color",n,t)}},{key:"getClient",value:function(e){return this.users[e]||(this.users[e]={})}},{key:"onDisconnect",value:function(e){var t=e.id;delete this.users[t],e.broadcast.to(this.docId).emit("client_left",t)}}]),t}();n.d(t,"TextOperation",function(){return u}),n.d(t,"SimpleTextOperation",function(){return g}),n.d(t,"WrappedOperation",function(){return w}),n.d(t,"Selection",function(){return x}),n.d(t,"AjaxAdapter",function(){return j}),n.d(t,"Client",function(){return B}),n.d(t,"CodeMirrorAdapter",function(){return q}),n.d(t,"SocketIOAdapter",function(){return G}),n.d(t,"EditorClient",function(){return ae}),n.d(t,"UndoManager",function(){return K}),n.d(t,"Server",function(){return de}),n.d(t,"EditorSocketIOServer",function(){return ke});t.default={TextOperation:u,SimpleTextOperation:g,WrappedOperation:w,Selection:x,AjaxAdapter:j,Client:B,CodeMirrorAdapter:q,SocketIOAdapter:G,EditorClient:ae,UndoManager:K,Server:de,EditorSocketIOServer:ke}}])});